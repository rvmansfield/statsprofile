{% extends 'main/base.html' %}

{% block title %}{{ user.username }}'s Profile{% endblock %}

{% block extra_css %}
  

    .profile-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 1rem;
    }
    .profile-header {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    .profile-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }
    .stat-card {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
    }
    .metrics-section {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .value {
        font-size: 1.1rem;
        font-weight: 500;
    }
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }
    .chart-container {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .chart-wrapper {
        height: 300px;
        margin: 1rem 0;
    }
    .no-data-message {
        text-align: center;
        color: #6c757d;
        padding: 2rem;
    }
    .percentile-badge {
        text-align: center;
        padding: 0.5rem 0.75rem;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 8px;
        font-weight: 600;
        font-size: 18pt;
        margin-top: 1rem;
        display: inline-block;
    }
    .percentile-badge.low {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    }
    .percentile-badge.medium {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    }
    .percentile-badge.high {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    .metric-rank-info {
        text-align: center;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }
    .latest-value {
        font-size: 40pt;
        font-weight: bold;
        color: #000000;
    }

    .latest-value-date {
        font-size: 14pt;
        color: #000000;
    }

    
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% for metric_type, data in metrics_data.items %}
        {% if data.has_data %}
        const ctx_{{ metric_type }} = document.getElementById('chart_{{ metric_type }}').getContext('2d');
        new Chart(ctx_{{ metric_type }}, {
            type: 'line',
            data: {
                labels: {{ data.labels|safe }},
                datasets: [{
                    label: '{{ data.display }}',
                    data: {{ data.values|safe }},
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: false,
                        text: '{{ data.display }} Progress'
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const label = context[0].label;
                                // Handle both array and string labels
                                if (Array.isArray(label)) {
                                    return label[0]; // Show only date in tooltip title
                                }
                                return label;
                            },
                            afterLabel: function(context) {
                                const label = context.label;
                                // Handle both array and string labels
                                if (Array.isArray(label) && label.length > 1) {
                                    return 'Captured By: ' + label[1];
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        reverse: {{ data.reverse|yesno:"true,false" }},
                        title: {
                            display: true,
                            text: '{{ data.unit }}'
                        }
                    },
                    x: {
                        title: {
                            display: false,
                            text: 'Date'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
        {% endif %}
    {% endfor %}
});

// Share profile functionality
function copyProfileUrl() {
    const url = window.location.href;
    const shareBtn = document.getElementById('share-btn');
    const shareBtnText = document.getElementById('share-btn-text');
    
    // Use the Clipboard API if available
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(url).then(function() {
            // Show success feedback
            shareBtnText.textContent = 'Copied!';
            shareBtn.classList.remove('btn-secondary');
            shareBtn.classList.add('btn-success');
            
            // Reset after 2 seconds
            setTimeout(function() {
                shareBtnText.textContent = 'Share Profile';
                shareBtn.classList.remove('btn-success');
                shareBtn.classList.add('btn-secondary');
            }, 2000);
        }).catch(function(err) {
            // Fallback to older method if clipboard API fails
            fallbackCopyTextToClipboard(url, shareBtn, shareBtnText);
        });
    } else {
        // Fallback for older browsers or non-secure contexts
        fallbackCopyTextToClipboard(url, shareBtn, shareBtnText);
    }
}

// Fallback method for copying text
function fallbackCopyTextToClipboard(text, btn, btnText) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            btnText.textContent = 'Copied!';
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-success');
            
            setTimeout(function() {
                btnText.textContent = 'Share Profile';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
            }, 2000);
        } else {
            alert('Failed to copy URL. Please copy manually: ' + text);
        }
    } catch (err) {
        alert('Failed to copy URL. Please copy manually: ' + text);
    }
    
    document.body.removeChild(textArea);
}
</script>
{% endblock %}

{% block content %}
<div class="container">
  <div class="row">
    <!-- Column 1: spans all 5 rows -->
    <div class="col-md-4 ">
      <div class="p-3 bg-white border h-100 d-flex flex-column align-items-center">
        <h2 class="text-center mb-3">{{ user.get_full_name|default:user.username }}</h2>
        
        <img src="{{ profile.picture.url }}" alt="{{ user.username }} picture" class="img-fluid mb-3" style="max-width:250px; max-height:200px; border-radius:8px;" />
        <!--

        <img src="{{ model.image.url }}" alt="{{ user.username }} picture" class="img-fluid mb-3" style="max-width:250px; max-height:200px; border-radius:8px;" />

-->
        {% if profile.bio %}
        <div class="bio-section text-center mb-4 w-100">
            <hr>
            <p>{{ profile.bio }}</p>
        </div>
        {% endif %}
        <div class="w-60 d-flex flex-column align-items-center mt-auto">
          {% if is_own_profile %}
          <a href="{% url 'edit_profile' %}" class="btn btn-primary w-100 mb-1">Edit Profile</a>
          <a href="{% url 'add' %}" class="btn btn-primary w-100 mb-1">Add Metrics</a>
          {% endif %}
          <a href="{% url 'playerevaluation' %}" class="btn btn-primary w-100 mb-1">Evaluation Tool</a>
          <button id="share-btn" class="btn btn-secondary w-100" onclick="copyProfileUrl()">
              <span id="share-btn-text">Share Profile</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Columns 2 and 3 split into 5 rows -->
    <div class="col-md-8">
      <div class="row">
        <div class="col-md-6 p-3 bg-white border"><div class="label">Positions</div>
                <div class="value">{{ profile.get_positions_display }}</div></div>
        <div class="col-md-6 p-3 bg-white border"><div class="label">Team</div>
                <div class="value">{{ profile.team|default:"Not set" }}</div></div>

        <div class="col-md-6 p-3 bg-white border"><div class="label">City</div>
                <div class="value">{{ profile.city|default:"Not set" }}</div></div>
        <div class="col-md-6 p-3 bg-white border"><div class="label">State</div>
                <div class="value">{% if profile.state %}{{ profile.get_state_display }}{% else %}Not set{% endif %}</div></div>

        <div class="col-md-6 p-3 bg-white border"><div class="label">Height</div>
                <div class="value">
                    {% if profile.height_inches %}
                        {{ profile.height_inches }} inches
                    {% else %}
                        Not set
                    {% endif %}
                </div></div>
        <div class="col-md-6 p-3 bg-white border"><div class="label">Weight</div>
                <div class="value">
                    {% if profile.weight_lbs %}
                        {{ profile.weight_lbs }} lbs
                    {% else %}
                        Not set
                    {% endif %}
                </div></div>

    <div class="col-md-6 p-3 bg-white border"><div class="label">Graduation Year</div>
        <div class="value">{{ profile.graduation_year|default:"Not set" }}</div></div>
    <div class="col-md-6 p-3 bg-white border"><div class="label">School</div>
        <div class="value">{{ profile.school|default:"Not set" }}</div></div>

    <div class="col-md-6 p-3 bg-white border"><div class="label">Throws</div>
        <div class="value">{% if profile.throws %}{{ profile.get_throws_display }}{% else %}Not set{% endif %}</div></div>
    <div class="col-md-6 p-3 bg-white border"><div class="label">Hits</div>
        <div class="value">{% if profile.hits %}{{ profile.get_hits_display }}{% else %}Not set{% endif %}</div></div>
      </div>
    </div>
  </div>
</div>



    <div class="charts-grid">
        {% for metric_type, data in metrics_data.items %}
            <div class="chart-container">
                <h3>{{ data.display }}</h3>
                {% if data.has_data %}
                    <div class="chart-wrapper">
                        <canvas id="chart_{{ metric_type }}"></canvas>
                    </div>
                    {% if data.latest_value %}
                        <div class="metric-rank-info">
                            <div class="latest-value">{{ data.latest_value|floatformat:1 }} {{ data.unit }}</div>
                            <div class="latest-value-date">Captured on {{ data.date_captured }}</div>
                            {% if data.has_percentile %}
                                
                                {% if metric_type == '60' %}
                                    {% if data.percentile == 0 %}
                                        <div class="percentile-badge high">
                                            Faster than the range for age {{ data.player_age }}
                                        </div>
                                    {% elif data.percentile == 100 %}
                                        <div class="percentile-badge low">
                                            Slower than the range for age {{ data.player_age }}!
                                        </div>
                                    {% elif data.percentile >= 75 %}
                                        <div class="percentile-badge">
                                            {{ data.percentile }}th Percentile - Below Average
                                        </div>
                                    {% elif data.percentile >= 50 %}
                                        <div class="percentile-badge medium">
                                            {{ data.percentile }}th Percentile - Above Average
                                        </div>
                                    {% else %}
                                        <div class="percentile-badge high">
                                            {{ data.percentile }}th Percentile - Excellent! ‚≠ê
                                        </div>
                                    {% endif %}
                                {% else %}
                                    {% if data.percentile == 0 %}
                                        <div class="percentile-badge low">
                                            At or below minimum for age {{ data.player_age }}
                                        </div>
                                    {% elif data.percentile == 100 %}
                                        <div class="percentile-badge high">
                                            At or above maximum for age {{ data.player_age }}! üéâ
                                        </div>
                                    {% elif data.percentile >= 75 %}
                                        <div class="percentile-badge">
                                            {{ data.percentile }}th Percentile - Excellent! ‚≠ê
                                        </div>
                                    {% elif data.percentile >= 50 %}
                                        <div class="percentile-badge medium">
                                            {{ data.percentile }}th Percentile - Above Average
                                        </div>
                                    {% else %}
                                        <div class="percentile-badge low">
                                            {{ data.percentile }}th Percentile - Below Average
                                        </div>
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                    <div class="no-data-message">
                        No {{ data.display|lower }} metrics recorded yet
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>


   


{% endblock %}
